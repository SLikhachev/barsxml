# Barsxml библитека для фрмирования zip пакетов файлов xml

## Назначение

Библиотека предназначена для формирования фрйлов xml на основе правил ФФОМС (Федеральный фонд ОМС).
Записи в файлах включают в себя случаи оказания медпомощи по ОМС пациентам в МО на территории
Приморского края.

Каждый сфорированный файл подписывается КУЭП, и далее все файлы упаковываются в архив zip.

## Установка

Проект был задуман в виде дистрибутива устанавлмваемого с

[https://test.pypi.org/simple/](https://test.pypi.org/simple/)

или

[https://test.pypi.org/simple/](https://test.pypi.org/simple/)

В текущей версии библотеки, эта идея до конца не реализвана. Предлагается устанавливать биюлиотеку
в виртуальное окружение Python непосредственно из репозитория

[git@github.com:SLikhachev/barsxml.git](git@github.com:SLikhachev/barsxml.git)

Зависимости перечислены в файле `requirements.txt`.

После установки внешних зависимостей, необходимо установить в виртуальное окружение и саму
библиотеку (так, что после обновления основной ветки репозитория в текущий каталог, будут
доступны самые последние изменения в библотеке):

`pip install -e .`

## Тестирование

Тесты написаны для небольшого количества случаев использования библиотеки и находятся в каталоге

`./src/brasxml/tests/`

В этом же каталоге должен находится подкаталог `data/`. Этот подкаталог не должен индексироваться git.
В __data__ будут формироватся тестовые пакеты для проверки работосбособности кода.
Примеры конфигураций для различных источников данных для библиотеки приведены в какталоге __tests__.

Для текстирования используется библиотека __pytest__, так что, она должна быть установлена в виртуальное
окрузение.

Для запуска тестов рекомендуется в корне пректа создать файл

`pytest_YOUR_TESTS_NAME.ini`

где `YOUR_TESTS_NAME` строка описывающая ваш конкретный набор тестов и тестовое окружение.

В качестве шаблона можно использовать прилагаемый файл

`pytest_demo.ini`

Запуск тестов производится командой:

`(venv)> pytest -c pytest_demo.ini`

Для запуска только опреленной функции тестового файла можно использовать команду:

`(venv)> pytest -c pytest_demo.ini src/barsxml/tests/test_pg_app.py::test_app`

## Подпись файлов отчетов электронной подписью

Подпись файлов выполняется в классе __src/barsxml/xmlproc/xmlsigner.py:XmlSigner__
Файлы подписываются с помощью Linux утилиты __openssl__ v >= 3.0.9.
Далее изложена инструкция по настройке пописи.

### Настройка утилиты openssl

Поскольку подпись выполняется по алгоритмам ГОСТ, необходимо установить GOST engine для openssl.

```sh
$> dnf install openssl-gost-engine
$> cp /etc/ssl/openssl.cnf /etc/ssl/openssl.cnf.bak
```

Здесь сделана резерная копия конфиг файла для openssl
В fedora39 файл /etc/ssl/openssl.cnf это ссылка:
`/etc/ssl/openssl.cnf -> /etc/pki/tls/openssl.cnf`

Далее необходимо отрактирвать конфиг файл, для этого внуобходимо:

1. Закоментировать дефолтные настройки (показаны уже закоментированные строки)

    ```conf
    # ----------- ssl_conf = ssl_module
    # ----------- [ ssl_module ]
    # ----------- system_default = crypto_policy
    # ----------- [ crypto_policy ]
    # ----------- .include = /etc/crypto-policies/back-ends/opensslcnf.config
    ```

2. Дабавить строки в конфиг

    - в самое начало файла:

        ```conf
        # --------------
        # openssl_conf = openssl_init
        # +++++++++++++++
        openssl_conf = openssl_def
        ...
        ```

    - в самый конец файла

        ```conf
        ...
        [openssl_def]
        engines = engine_section

        [engine_section]
        gost = gost_section

        [gost_section]
        engine_id = gost
        dynamic_path = /usr/lib64/engines-3/gost.so
        default_algorithms = ALL
        CRYPT_PARAMS = id-Gost28147-89-CryptoPro-A-ParamSet
        ```

3. Отредактирвать файлы

    `/etc/crypto-policies/back-ends/openssl.config , opensslcnf.config`

    Эти файлы являются ссылками на

```sh
        openssl.config -> /usr/share/crypto-policies/LEGACY/openssl.txt
        opensslcnf.config -> /usr/share/crypto-policies/LEGACY/opensslcnf.txt
```

Ссылки определяются глобальной криптополиткой

```sh
    $> update-crypto-policies --show
    # it may be LEGACY/DEFAULT/FUTURE it depends and def by the folder of /usr/shqre/crypto-policies/DEF
```

Для работы с ГОСТ подписью необходимо установить политику __default__

```sh
    $> update-crypto-policies --set DEFAULT
    $> systemclt reboot
```

Содержимое файлов `openssl.txt`, `opensslcnf.txt` для работы с ГОСТ находится в каталоге dist/crypto-policies/ проекта

Посмотреть алгоритмы ГОСТ можно командой

```sh
    $> openssl ciphers | tr ':' '\n'|grep GOST
```

### Получение сертификатов и ключей для подписи

Предполагается что у пользователя имеется сертфикат открытого ключа (плюс приыватный ключ ) предназначенный
для ЭЦП, и этот сертификат сформирован с помощью утилиты Крипто-ПРО. В данном руководстве разъясняется
как сформировать необходимые файлы сертификатов и ключей для пакета BrasXml, если сертификат для
подписи хранится в контейнера на устройстве Рутокен-Лайт, или имеется возможость извлечь
сертифик открытого ключа и приватный ключ сертификата.

#### Получение приватного ключа

Если приватный ключ сертификата получить нет возможности, то данная схема подписания файлов
отчетов работать не будет.

Прежде всего необходимо извлечь закрытый ключ Крипто-ПРО ГОСТ из контенера где он хранится.
Если сертификат хранится в контейнере типа Рутокен-Лайт, закрытый ключ ГОСТ можно извлечь с помощью
утилиты Tokens.exe, которая находится в каталоге dist/Tokens/ проекта. Утилита работает только под Windows.
Извлекаем ключ и копируем его в Linux каталог `~/keys/2023/private`.

Если ключи хранятся как-то по другому, нужно будет найти инструмент для извлечения ключей.

Ключ по ГОСТ в контейнере Критпо-ПРО хранится в каталоге с содержимым типа такого

```sh
    -rw-r--r-- 1 2,8K янв 24  2023 header.key
    -rw-r--r-- 1 60 янв 24  2023 masks.key
    -rw-r--r-- 1 60 янв 24  2023 masks2.key
    -rw-r--r-- 1 300 янв 24  2023 name.key
    -rw-r--r-- 1 70 янв 24  2023 primary.key
    -rw-r--r-- 1 70 янв 24  2023 primary2.key
```

Преобразовать приватный ключ в формат __pem__ из этого каталога можно с помощью утилиты
__Privkey2012__, которая находится в каталоге `dist/gostpem` проекта

Можно постороить __docker__ образ этой утилиты самостотельно по инструкциии в каталоге, или скачать из
репозитория `hub.docker.io`. В любом случае на ПК должен быть установлен демон docker.

```sh
$> dnf install docker
```

Для запуска утилиты рекомендуется скачать докер образ пргораммы `zazmaster/gostpemextractor` с
hub.docker.io

```sh
$> service docker start
$> docker pull zazmaster/gostpemextractor
```

Для удобства можно переименовать тег образа (здесь 3df это первые 3 цифры image ID)

```sh
$> docker image tag 3df zaz/gostpem:latest
$> docker rmi zazmaster/gostpemextractor
```

Для извлечения приватного ключа в формате pem, переходим в рабочий каталог с извлченным приватным
ключем ГОСТ, и запускаем контейнер из образа, (предположим что ключ ГОСТ хранится в каталоге
~/keys/2023/private)

```sh
cd ~/keys/2023
```

Запуск контейнера из образа выполняется командой (здесь контйнер запускается в интерактивном режиме):

```bash
$> docker run -it -v `pwd`:/work  --entrypoint /bin/bash zaz/gostpem
```

Если уже есть готовый контенер (остановленный), его можно запустить командой

```sh
docker ps -a # выводит список всех контейнеров
docker contaner restart 3df # рестартуем ранее остановленный контайнер
docker contaner attach 3df # интерактивно подключаемся к контейнеру
```

В интерактивном режиме выполняем (private/ каталог где лежит контейнер с приватным ключем по ГОСТ)

```sh
privkey2012 private > key.pem` # в каталоге 2024 будет файл hok.pem с закрытым ключем
exit # выходим из интерактивного режима
$> docker container stop 3df
```

Таким образом у нас имеется закрытый ключ `key.pem` в каталоге `~/keys/2023/`.

### Трансформация сертификатов

Для закрытого ключа необходим сертификат, для подтверждения подлинности сертификата нужна
цепочка подтверждения сертификата ключа. Мы используем следующие форматы сертифиактов для подписи
(pem - текстовый файл в кодировке base64, der - бинарный файл сертификата)

- Приватный ключ: key.pem
- Сертификат открытого ключа: crt.der
- Цепочка сертификатов удостоверяющих сертификат открытого ключа: ca.pem

Ключ key.pem уже создан на предыдущем этапе. Сертификат открытого ключа может быть получен
сохранением в файл crt.der установленного в реестр windows сертификата открытого ключа из контейнра
Рутокен-лайт.

Пара сертификатов подтверждения:

- Сертифиакт МНС (налоговая)
- Корневой сертификат МЦР (Минцифры)

может быть получена из сохраненных в файлах на дске der сертификатов.

- Серитфикат МНС в формате pem

```sh
user> openssl x509 -inform der -in fns.crt -out fns.pem
```

- Серитфикат МЦР в формате pem

```sh
user> openssl x509 -inform der -in mcr.crt -out mcr.pem
 ```

- Сливаем оба сертификата в цепочку

```sh
user> cat mcr.pem fns.pem > ca.pem
```

Полученные файлы:

```sh
key.pem
crt.der
ca.pem
```

нужно скопировать в подквталог `reestr/pem/` каталога в ктором формируются файлы пакета.

### Получение и провера электронной подписи

Электронная подпись файла выпролняется командой

```sh
$> /usr/bin/openssl cms -sign -signer {crt} -inkey {key} -CAfile {ca} \
-engine gost -binary -outform DER \
-in {file_name}.xml -out {file_name}.sig
```

Здесь:

crt - файл сертификата открытого ключа crt.der
key - файл приватного ключа key.pem
ca - файл цепочки удостоверяющих сертификтов
file_name - наименование файла котрый нужно подеписать

Для проверки работоспособности необходимо в приложении task_rest подписать файлы пакета, и
затем проверить файлы подписи с помощью Крипто-ПРО.


__За подробной документацией обращайтест к автору проекта по электропочте;__

[polaughing@yahoo.com](polaughing@yahoo.com)

[aughing@hotmail.com](aughing@hotmail.com)
